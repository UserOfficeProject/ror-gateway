<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Searchable Dropdown</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Adjust this value to fit your needs */
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-input {
        width: 200px;
        padding: 5px;
        font-size: 16px;
      }

      .dropdown-list {
        position: absolute;
        z-index: 1;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 5px;
      }

      .dropdown-list-item {
        padding: 5px;
        cursor: pointer;
      }

      .dropdown-list-item:hover {
        background-color: #ddd;
      }
    </style>
  </head>
  <body>
    <div class="dropdown">
      <input
        class="required required-missing-display"
        id="mail"
        autocomplete="user-text"
        type="text"
        name="affiliation"
        value=""
      />
    </div>

    <script>
      // Add listener here for keyup
      var timeoutId;
      var searchInput = document.querySelector('input[name="affiliation"]');
      searchInput.addEventListener("keyup", debounce(searchDropdown, 500));

      //Add searchResults after searchInput
      var searchResults = document.createElement("div");
      searchResults.className = "dropdown-list";
      searchResults.id = "searchResults";

      searchInput.parentNode.insertBefore(
        searchResults,
        searchInput.nextSibling
      );

      //TODO add country before input element
      function createListItem(text, parent) {
        var listItem = document.createElement("div");
        listItem.classList.add("dropdown-list-item");
        listItem.innerText = text;
        parent.appendChild(listItem);

        return listItem;
      }

      function searchDropdown() {
        var input = document.querySelector('input[name="affiliation"]');
        var query = input.value;
        var searchResults = document.getElementById("searchResults");

        // Clear previous search results
        searchResults.innerHTML = "";

        if (query.length >= 3) {
          // Construct the API URL with the query and country code
          var apiUrl =
            "https://api.ror.org/organizations?affiliation=" +
            encodeURIComponent(query);
          var setResults = function (elem) {
            input.value = elem.srcElement.innerHTML;
            searchResults.innerHTML = "";
          };
          // Make API request
          fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
              // Process the API response and populate the dropdown list

              if (data.items != 0) {
                data.items.forEach((item) => {
                  var itemDiv = createListItem(
                    item.organization.name,
                    searchResults
                  );
                  itemDiv.onclick = setResults.bind(item.organization.name);
                });
              } else {
                createListItem("No results found", searchResults);
              }
            })
            .catch((error) => {
              console.error("Error fetching data from the API:", error);
            });
        } else {
          createListItem("Minimum three characters", searchResults);
        }
      }

      function debounce(func, delay) {
        return function () {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(func, delay);
        };
      }
    </script>
  </body>
</html>
